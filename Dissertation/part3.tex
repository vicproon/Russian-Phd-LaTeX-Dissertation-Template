\chapter{Восстановление в белом пучке} \label{chapt3}
\section{Введение}

Цель данной главы - борьба с одним из артефактов восстановления, так называемым эффектом огрубления пучка или Beam Hardening. 
Причина возникночения таких артефактов - несоответствие излучения реального источника монохроматическому описанию, используемому в моделях для процедуры восстановления. 
В работе восстановление производится в 2D-сечении и задача рассматривается в параллельном пучке.

\section{итерация алгебраического метода} \label{sect3_1}
\todo{текст ИТИС-2015}

%  В главе 2 будет представлена модель прямой проекции а так же алгебраический
%  метод для монохроматического источника излучения. Затем, в главе 3 будет
%  поставлена задача восстановления в монохроматическом пучке. Наконец, в гла-
%  ве 4 будут приведена соответствующая модификация алгебраического метода
%  для решения соответствующей задачи.

\begin{comment}
% Томография при Монохроматическом Излучении
% В текущей главе мы представляем алгебраический метод для случая монохро-
% матического излучения. Пусть f(x, y) – восстанавливаемое распределение ли-
% нейного коэффициента ослабления объекта. Пусть на объект падает параллель-
% ный пучок лучей интенсивностью 
%I 0 под углом φ. 
Тогда интенсивность излуче-
ния вдоль некоторого бесконечно тонкого луча со сдвигом s, %l(φ, s)
 после про-
хождения через объект будет
% I(l(φ, s)) = I 0 exp (− ∫ f(x, y)dl).
% (1)
Для краткости записи далее аргументы угла и сдвига, задающие прямую %l(φ, s)

будут опускаться. Данные значения подвергаются нормировке и логарифмиро-
ванию, в результате восстанавливается распределение линейного коэффициента
ослабления для энергии зондирующего излучения, путем решения системы
уравнений:
% ln (I 0 /I(l) ) = p(l) = ∫ f(x, y)dl
для всех углов измерения %φ
 и сдвигов s. Оператор интегрирования вдоль всех
возможных направлений называется преобразованием Радона. При восстановлении реальных измерений как входные данные% p(φ, s),
так и искомая характе-
ристика f(x, y) представляются дискретными изображениями размеров 
%N × M φ и N × N, 
соответственно, а преобразование Радона заменяется на преобра-
зование Хафа.
Для восстановления распределения линейного коэффициента ослабления ис-
пользуются в основном интегральные или алгебраические методы [4]. Особый
интерес представляют последние, так как их, как будет показано ниже, можно
использовать и для восстановления экспериментов, проводимых с использова-
нием немонохроматического пучка. Пусть 
%f ∈ R N×N и p ∈ R N×M φ %
– соответ-
ственно входные и выходные данные, H – матрица линейного преобразования
Хафа размера 
%N 3 M φ ≈ N 4
 . Тогда томографическую проекцию можно записать
в виде СЛАУ
%p = Hf.
Решение этой СЛАУ методом наименьших квадратов в явном виде невозможно
ввиду огромного размера матрицы H, однако ее умножение на вектор f, как и
умножение транспонированной матрицы H T может быть посчитано быстро за
O(N 2 log N) используя методы обработки изображений [5]. Применяя метод
градиентного спуска для минимизации L2 нормы расхождения, получаем шаг
градиентного спуска
%f ξ = f ξ−1 + αH T (Hf ξ−1 − p), где
%α - параметр релаксации.
\end{comment}

\section{Модель томографии при немонохроматичесвом излучении}

В реальности спектр используемого для зондирования излучения не сингулярный, а коэффициент ослабления объекта меняется в зависимости от длины волны ($I_0 = I_0(\lambda), f(x, y) = f(x, y, \lambda)$).

Таким образом, при переходе к немонохроматическому случаю, уравнение \ref{eq:mono_fp} принимает следующий вид:

\begin{equation}
\label{eq:white_fp}
I(l) = \int_0^{+\infty}{\left\{
  I_0(\lambda) \exp{\left(-\int{f(x, y, \lambda) dl} \right) d\lambda} 
  \right\}}  
\end{equation}

Таким образом, оператор проецирования становится нелинейным.
При этом в случае, когда источник все же монохроматический, то есть $I_0(\lambda) = \delta(\lambda)$ легко видеть, что уравнение (\ref{eq:white_fp}) переходит обратно в (\ref{eq:mono_fp}).
Спектр используемого в экспериментах источника излучения можно измерить в лабораторных условиях и поэтому считается известным.
Переход к нелинейной задаче не был бы столь существенным, если бы при этом не терялась возможность восстановить зависимость подынтегральной функции от переменной интегрирования. 
Иными словами, без дополнительных знаний о структуре объекта, восстановить искомую функцию $f(x, y, \lambda)$ невозможно.

Предлагается использовать следующую модель формирования функции f %\cite{?}.
Будем считать, что исследуемый объект состоит из смеси K известных элементов, для которых известны их спектральные функции поглощения $f_k(\lambda)$.

Данные функции являются известными величинами, которые можно измерить в лабораторных условиях. В частности в данной работе были использованы значения, возвращаемые функциями библиотеки xraylib \cite{xraylib}.
При этом неизвестными будут пространственные распределения концентрации $c_k(x, y)$ каждого элемента.
\begin{equation}
 \notag
  f(x, y, \lambda) = \sum_{s=1}^K {c_s(x, y) \cdot f_s(\lambda)}
\end{equation}

Учитывая то, что интеграл внутри экспоненцирования – линейный оператор прямой проекции $H$, получим общее значение ослабления интенсивности входного излучения для смеси $c = (c_1, \dots, c_K)^T $ в пикселе измерения $j$ при линейном размере пикслея $\rho$:
\begin{equation}
  \label{eq:white_fp_final}
  I(c)_j = \int_0^{+\infty} {d\lambda \left\{
    I_0(\lambda) \exp{\left(
      -\sum_{k=1}^K {\rho f_k(\lambda) (H c_k)_j} 
      \right)}
  \right\}}
\end{equation}

Далее будет предложен итерационный процесс восстановления концентраций $с_k$, основанный на алгебраическом методе и минимизации $L_2$-нормы.

\section{Алгебраический Метод для Немонохроматического Случая}

В финале раздела будет выведена формула для расчета поправки на каждом шаге итерации метода восстановления концентраций $c_k$.
Пусть далее $i$ индексирует пиксели в пространстве исходных изображений-концентраций размера $N \times N$, $j$ индексирует пиксели в пространстве входных изображений-измерений размера $N \times M_\varphi$, а $k$, как и раньше, принимает значения $1 \dots K$ и индексирует различные элементы, составляющие исследуемый объект.
Пусть $h_{ij}$ – элементы матрицы прямой томографической проекции H.
Обозначим так же значения, измеренные детектором за $t$

Для того, чтобы выписать минимизационную процедуру необходимо составить функцию невязки.
По аналогии с выводом итерации алгебраического метода для монохроматичного случая, можно взять квадратичную невязку вида $(I(c) - t)^2$.
Однако эта величина размерная и зависит от суммарной мощности просвечивающего пучка.
Поэтому предлагается минимизировать невязку нормированных интенсивностей на величину $ S = \int_0^{+\infty}{I(\lambda)d\lambda}$.
Итак финальная функция для оптимизации имеет вид:
\begin{equation}
\label{eq:white_cost_function}
Q(c) = \left(\frac{I(c) - t}{S}\right)^2,
\end{equation} 
где за возведение в квадрат подразумевается обычная эвклидова норма разницы векторов размера $N \times M_\varphi$.

Для того, чтобы выстроить итерационный процесс вычисления концентраций, необходимо подсчитать градиент весовой функции по концентрациям каждого из элементов. 
Сделаем это покомпонентно:
\begin{equation}
  \notag
  \frac {\partial Q_j} {\partial c_{ki}} = 
  2 \frac {(I(c) - t)_j} {S} 
  \frac {\partial } {\partial c_{ki}}
  \left( \frac {I(c)_j} {S} \right).
\end{equation}

Рассчитаем возникшую частную производную:
\begin{equation}
  \notag
  \begin{split}
  \frac 1 S
  \frac {\partial I(c)_j} {\partial c_{ki}} &= 
  \frac 1 S
  \int_0^{+\infty} {d\lambda \left\{
    I_0(\lambda) 
    \frac \partial {\partial c_{ki}}
    \exp{\left(
      -\sum_{s=1}^K {\rho f_s(\lambda) (H c_s)_j} 
      \right)}
    \right\}} = \\
  &= 
  \int_0^{+\infty} {d\lambda \left\{
    -\rho f_k(\lambda) 
    \frac {I_0(\lambda)} {S}
    \exp{\left(
      -\sum_{s=1}^K {\rho f_s(\lambda) (H c_s)_j} 
         \right)}
    \frac {\partial (H c_k)_j} {\partial c_{ki}}
    \right\}} = \\
  &= 
  \frac {\mu_{kj}} {S} \frac {\partial (H c_k)_j} {\partial c_{ki}},
  \end{split}
\end{equation}

где введено обозначение $\mu_k$ для весовых коэффициентов, имеющих размерность синограммы и зависящих от элемента и прямой проекции:

\begin{equation}
  \label{eq:weights}
  \mu_{k} = \int_0^{+\infty} {d\lambda \left\{
    -\rho f_k(\lambda) 
    I_0(\lambda)
    \exp{\left(
      -\sum_{s=1}^K {\rho f_s(\lambda) (H c_s)} 
         \right)}
    \right\}}
\end{equation}

Эти коэффициенты должны учитывать спектральное взаимодействие различных элементов с источником, взвешивая невязку для каждого элемента, благодаря чему на каждой итерации вклад в разные концентрации будет разный.

Заметим, что производная $\frac {\partial (H c_k)_j} {\partial c_{ki}}$ соответствует обратной проекции в алгебраической процедуре восстановления. 
Таким образом, шаг итерации будет иметь вид
\begin{equation}
  \nabla_k \ Q = 2H^\intercal R_k \text{, где } R_{kj} = \frac {(I(c) - t)_j} {S} \mu_{kj}
\end{equation}

(6)
Где за R k обозначена взвешенная невязка для элемента k. Таким образом, мы
вычислили компоненты градиента по каждому из составляющих исходный объ-
ект элементу. Как видно из формулы (6), компоненты градиентов по различным
элементам могут вычисляться отдельно. Тем не менее, не стоит забывать, что
все элементы связаны через взвешенные невязки R k , в которых содержится
зависимость от всего вектора c. Итак, наконец, шаг итерации алгоритма выгля-
дит следующим образом:
\begin{equation}
  \label{white_iteration}
  c_k^\xi
\end{equation}

% ξ
% ξ−1
% с k = c k
% 5
% − α k (ξ − 1)H T R k (c ξ−1 ) .
% (7)
Заключение
Была рассмотрена задача компьютерной томографии для восстановления изме-
рений, полученных при использовании немонохроматического источника излу-
чения. При этом привлекаются дополнительные знания относительно структуры
элементов, из которых состоит объект. Был явно выписан шаг итерации алгеб-
раического метода, восстанавливающего распределения концентраций состав-
ляющих объект элементов.
Для внесения ясности приведем псевдокод алгоритма восстановления:
Вход: %f k\delta(\lambda), I 0\delta(\lambda), t = I(φ, s)
Выход: %c k x, y)
Инициализация c
%Q <- (I(c) − t) 2
Пока Q > eps:
Вычисление весовых коэффициентов %μ jk по (5).
Вычисление взвешенных невязок R k по (6)
% ξ
Обновление c k по (7)
% Q <- (I(c) − t) 2
В дальнейшем мы планируем произвести оптимальную численную реализа-
цию алгоритма и проведение тестов как на модельных, так и на реальных дан-
ных, регистрируемых на лабораторном микротомографе, разработанном и
функционирующем в ИК РАН [6].

\section{численный эксперимент } \label{sect_3_2}
Одним из результатов данной работы является программная реализация и исследование работа алгоритмя восстановления, основанного на взешенных невязках.
